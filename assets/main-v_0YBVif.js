(function(){"use strict";var r=(e=>(e.Number="number",e.Int8="int8",e.Uint8="uint8",e.Int16="int16",e.Uint16="uint16",e.Int32="int32",e.Uint32="uint32",e.Float32="float32",e.Float64="float64",e.Color="color",e.String="string",e.Date="date",e))(r||{});function d(e){switch(e){case"int8":case"uint8":return 1;case"int16":case"uint16":return 2;case"int32":case"uint32":case"float32":case"number":return 4;case"float64":case"date":return 8;case"color":return 16;case"string":default:return 0}}function P(e){switch(e){case"number":case"float32":case"float64":return!0;default:return!1}}function M(e){switch(e){case"int8":case"uint8":case"int16":case"uint16":case"int32":case"uint32":return!0;default:return!1}}const V=1,D=new RegExp(/^(#|0x)?(([0-9a-f]{3}){1,2}|([0-9a-f]{4}){1,2})$/i);function G(e,t=!1){const n=[0,0,0,V];if(!D.test(e))return t||console.warn("hexadecimal RGBA color string must conform to either","#0000, or #00000000, given",e),n;const s=e.startsWith("0x")?2:e.startsWith("#")?1:0,a=Math.floor((e.length-s)/3),c=a-1;return n[0]=parseInt(e[s+0*a]+e[s+0*a+c],16)/255,n[1]=parseInt(e[s+1*a]+e[s+1*a+c],16)/255,n[2]=parseInt(e[s+2*a]+e[s+2*a+c],16)/255,(e.length-s===4||e.length-s===8)&&(n[3]=parseInt(e[s+3*a]+e[s+3*a+c],16)/255),!t&&(isNaN(n[0])||isNaN(n[1])||isNaN(n[2])||isNaN(n[3]))&&console.warn(`expected well formatted hexadecimal RGBA string, given '${e}'`),n}function H(e,t){return e.map((n,s)=>{if(P(t[s]))return Number.parseFloat(n);if(M(t[s]))return Number.parseInt(n);switch(t[s]){case r.Color:return G(n);case r.Date:{let a=Date.parse(n);return isNaN(a)&&(a=Number.parseInt(n)),new Date(a)}case r.String:return n;default:return}})}class ${constructor(){this._samples=new Map}start(t,n=t.toString()){if(this._samples.has(t)){console.warn("performance measurement already exists");return}this._samples.set(t,{start:Date.now(),end:0,delta:0,label:n})}stop(t){if(!this._samples.has(t)){console.warn("performance measurement doesn't exist");return}const n=this._samples.get(t);n.end=Date.now(),n.delta=n.end-n.start}get samples(){return[...this._samples.values()]}}function O(e,t){const n=new Array;let s=0,a=!1,c=!1;const f=u=>{n.push(e.substring(a?s+1:s,a?u-1:u))};for(let u=0;u<e.length;u++){if(e.charAt(u)==='"'){c=!c,a=!0;continue}if(c)continue;const{end:i,skip:dt}=Y(e,u,t);i&&(f(u),s=u+dt,a=!1)}return f(void 0),n}function Y(e,t,n){switch(e.charAt(t)){case n:case`
`:return{end:!0,skip:1};case"\r":if(e.charAt(t+1)===`
`)return{end:!0,skip:2};default:return{end:!1,skip:0}}}function U(e,t,n){switch(n.type){case r.Number:n.set(t,e);break;case r.Color:n.set(t,e);break;case r.Date:n.set(t,e);break;case r.String:n.set(t,e);break}}function b(e,t){return t?new SharedArrayBuffer(e):new ArrayBuffer(e)}class E{constructor(t,n,s){this._type=t,this._length=n,this._offset=s}get type(){return this._type}get length(){return this._length}get offset(){return this._offset}set offset(t){this._offset=t}}class C extends E{get data(){return this._data}}class z extends C{constructor(t,n,s){super(r.Color,t,n),this._data=b(t*4*4,s),this._view=new Float32Array(this._data)}get view(){return this._view}get(t){return Array.from(this._view.subarray(t*4,(t+1)*4))}set(t,n){this._view.set(n,t*4)}}class X extends C{constructor(t,n,s){super(r.Date,t,n),this._data=b(t*d(r.Date),s),this._view=new Float64Array(this._data),this._min=Number.POSITIVE_INFINITY,this._max=Number.NEGATIVE_INFINITY}get view(){return this._view}get rawMin(){return this._min}get rawMax(){return this._max}get min(){return new Date(this._min)}get max(){return new Date(this._max)}updateExtrema(t){t<this._min&&(this._min=t),t>this._max&&(this._max=t)}rawGet(t){return this._view[t]}rawSet(t,n){this._view[t]=n,this.updateExtrema(n)}get(t){return new Date(this._view[t])}set(t,n){const s=n.getTime();this._view[t]=s,this.updateExtrema(s)}}class m extends C{constructor(t,n,s,a){super(r.Number,t,n),this._data=b(t*s,a),this._min=Number.POSITIVE_INFINITY,this._max=Number.NEGATIVE_INFINITY}get view(){return this._view}get min(){return this._min}get max(){return this._max}get(t){return this._view[t]}set(t,n){this._view[t]=n,n<this._min&&(this._min=n),n>this._max&&(this._max=n)}}class j extends m{constructor(t,n,s){super(t,n,d(r.Int8),s),this._view=new Int8Array(this._data)}}class q extends m{constructor(t,n,s){super(t,n,d(r.Uint8),s),this._view=new Uint8Array(this._data)}}class J extends m{constructor(t,n,s){super(t,n,d(r.Int16),s),this._view=new Int16Array(this._data)}}class K extends m{constructor(t,n,s){super(t,n,d(r.Uint16),s),this._view=new Uint16Array(this._data)}}class Q extends m{constructor(t,n,s){super(t,n,d(r.Int32),s),this._view=new Int32Array(this._data)}}class Z extends m{constructor(t,n,s){super(t,n,d(r.Uint32),s),this._view=new Uint32Array(this._data)}}class T extends m{constructor(t,n,s){super(t,n,d(r.Float32),s),this._view=new Float32Array(this._data)}}class tt extends m{constructor(t,n,s){super(t,n,d(r.Float64),s),this._view=new Float64Array(this._data)}}class et extends E{constructor(t,n,s){super(r.String,t,n),this._data=new Array(t)}get(t){return this._data[t]}set(t,n){this._data[t]=n}}function nt(e,t,n,s){switch(e){case r.Number:case r.Float32:return new T(t,n,s);case r.Int8:return new j(t,n,s);case r.Uint8:return new q(t,n,s);case r.Int16:return new J(t,n,s);case r.Uint16:return new K(t,n,s);case r.Int32:return new Q(t,n,s);case r.Uint32:return new Z(t,n,s);case r.Float64:return new tt(t,n,s);case r.Color:return new z(t,n,s);case r.Date:return new X(t,n,s);case r.String:return new et(t,n,s);default:return}}function W(e,t){const s=nt(e._type,0,0,t);return Object.assign(s,e)}var A=(e=>(e[e.Start=0]="Start",e[e.Finished=1]="Finished",e))(A||{}),w=(e=>(e[e.Setup=0]="Setup",e[e.AddChunk=1]="AddChunk",e[e.NoMoreChunks=2]="NoMoreChunks",e[e.Processed=3]="Processed",e[e.Finished=4]="Finished",e))(w||{});const st=self;let o;const p=new Array,rt=25;let _,B=0,L=0,N=0,k=!1;const I=new $,g=new Map,v=new Map,F=new Map,x=new Map,y=new Map;let l=0,S=0;st.onmessage=e=>{const t=e.data;switch(t.type){case w.Setup:o=t.data;break;case w.AddChunk:at(t.data);break;case w.NoMoreChunks:it();break;default:o.options.verbose&&console.log("received invalid msg from frontend thread:",t);break}};function at(e){p.push(e.chunk),_||ot(e.chunk),L++,B+=e.chunk.byteLength,!(p.length<_)&&R()}function it(){k=!0,R()}function ot(e){if(o.options.size){const t=e.byteLength,n=this._size/t;_=Math.ceil(n/rt)}else _=100}function R(){const e=Math.max(p.length,_),t=p.splice(0,e),n=N++,s=new Worker(new URL("/treemap-renderer/assets/sub-Dod_SwXw.js",self.location.href),{type:"module"});s.onmessage=u=>{const h=u.data;u.data.type!==A.Finished&&o.options.verbose&&console.log("received invalid msg from sub worker:",h),ut(h.data,n)};const a={chunks:t,columns:o.columns,generatedColumns:o.generatedColumns,options:{delimiter:o.options.delimiter,includesHeader:o.options.includesHeader&&n===0},lastChunk:k},c={type:A.Start,data:a},f=`worker ${n}`;o.options.verbose&&console.log("starting "+f),g.set(n,s),I.start(n,f),s.postMessage(c,[...t])}function ut(e,t){I.stop(t),o.options.verbose&&console.log(`worker ${t} done`);const n=g.get(t);g.delete(t),v.set(t,e.chunks.map(a=>W(a,o.options.sharedArrayBuffer))),F.set(t,e.generatedChunks.map(a=>W(a,o.options.sharedArrayBuffer))),x.set(t,e.startRemainder),y.set(t,e.endRemainder);let s=!1;do s=ct();while(s);k&&g.size===0&&lt(),n.terminate()}function ct(){const e=v.get(l),t=F.get(l),n=y.get(l),s=x.get(l+1),a=k&&N===l+1;if(!(e&&t&&n&&(s||a)))return!1;if(!a){const i=new Uint8Array(n.byteLength+(s?.byteLength??0));i.set(new Uint8Array(n)),i.set(new Uint8Array(s),n.byteLength),ht(i,e,t)}e.forEach(i=>i.offset=S),t.forEach(i=>i.offset=S),S+=e[0].length,v.delete(l),F.delete(l),y.delete(l),x.delete(l+1);const f={chunks:[...e,...t]},u={type:w.Processed,data:f},h=o.options.sharedArrayBuffer?f.chunks.map(i=>i.data):[];return postMessage(u,h),l++,!0}function ht(e,t,n){const s=new TextDecoder().decode(e),a=O(s,o.options.delimiter),c=H(a,o.columns);c.forEach((h,i)=>U(h,t[i].length-1,t[i])),o.generatedColumns.map(h=>h.func(a,c)).forEach((h,i)=>U(h,n[i].length-1,n[i]))}function lt(){const e={chunks:L,bytes:B,workers:N,performance:I.samples},t={type:w.Finished,data:e};postMessage(t)}})();
